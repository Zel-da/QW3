================================================================================
FoodieMatch 프로젝트 전체 구조 및 설계 문서
================================================================================
작성일: 2025-11-21
버전: 1.0
프로젝트 경로: C:\Users\Administrator\Downloads\QW3\FoodieMatch

================================================================================
1. 프로젝트 개요
================================================================================

[프로젝트 정보]
- 프로젝트명: FoodieMatch (안전관리 플랫폼)
- 목적: 안전교육, TBM(Tool Box Meeting), 안전점검, 결재 시스템 통합 관리
- 개발 환경:
  * 개발 서버: http://localhost:5173 (Frontend)
  * API 서버: http://localhost:5001 (Backend)
- 데이터베이스: PostgreSQL with Prisma ORM
- 인증 방식: Session-based authentication with express-session

[기술 스택]

Frontend:
- React 18 + TypeScript
- Vite (빌드 도구)
- TailwindCSS + Radix UI (UI 프레임워크)
- TanStack Query (서버 상태 관리)
- Zustand (클라이언트 상태 관리)
- React Hook Form + Zod (폼 관리 및 검증)
- Wouter (라우팅)
- Recharts (차트/통계)
- react-dropzone (파일 업로드)

Backend:
- Node.js + Express.js
- TypeScript (ESNext)
- Prisma Client (ORM)
- bcrypt (비밀번호 암호화)
- Multer (파일 업로드)
- ExcelJS (엑셀 처리)
- Sharp (이미지 처리)
- Winston (로깅)
- node-cron (스케줄러)
- Nodemailer (이메일)

Database:
- PostgreSQL (메인 데이터베이스)
- 32개 데이터 모델
- Prisma Schema 기반 타입 안전성

================================================================================
2. 프로젝트 구조
================================================================================

[전체 디렉토리 구조]

FoodieMatch/
├── client/                    # React 프론트엔드
│   ├── src/
│   │   ├── components/        # 재사용 컴포넌트
│   │   │   ├── ui/           # Radix UI 기반 컴포넌트 (50+ 컴포넌트)
│   │   │   ├── ProtectedRoute.tsx
│   │   │   ├── LoadingSpinner.tsx
│   │   │   ├── ErrorBoundary.tsx
│   │   │   ├── FileDropzone.tsx (신규 추가)
│   │   │   ├── DashboardStats.tsx (신규 추가)
│   │   │   └── ...
│   │   ├── pages/            # 페이지 컴포넌트 (29개)
│   │   │   ├── DashboardHomePage.tsx
│   │   │   ├── LoginPage.tsx
│   │   │   ├── AdminPage.tsx
│   │   │   ├── TbmPage.tsx
│   │   │   ├── SafetyInspectionPage.tsx
│   │   │   ├── NoticeEditor.tsx
│   │   │   ├── NoticeDetailPage.tsx
│   │   │   ├── EducationManagementPage.tsx
│   │   │   ├── EmailSettingsPage.tsx
│   │   │   └── ...
│   │   ├── features/         # 기능별 모듈
│   │   │   └── tbm/          # TBM 관련 컴포넌트
│   │   │       └── TBMChecklist.jsx
│   │   ├── context/          # React Context
│   │   │   └── AuthContext.tsx
│   │   ├── hooks/            # 커스텀 훅
│   │   ├── lib/              # 유틸리티
│   │   │   ├── queryClient.ts
│   │   │   ├── utils.ts
│   │   │   └── constants.ts
│   │   ├── config/           # 설정
│   │   ├── main.tsx          # 엔트리 포인트
│   │   ├── App.tsx           # 라우팅 정의
│   │   └── index.css         # 글로벌 스타일
│   └── index.html
├── server/                   # Express 백엔드
│   ├── index.ts             # 서버 엔트리 포인트
│   ├── routes.ts            # API 라우트 정의 (6027줄, 123개 엔드포인트)
│   ├── db.ts                # Prisma Client 싱글톤
│   ├── middleware.ts        # RBAC 미들웨어
│   ├── emailService.ts      # 이메일 발송 서비스
│   ├── scheduler.ts         # Cron 스케줄러
│   ├── conditionExecutor.ts # 조건부 이메일 실행
│   ├── emailConditions.ts   # 이메일 조건 체커
│   ├── logger.ts            # Winston 로거
│   ├── vite.ts              # Vite 개발 서버 설정
│   └── ... (총 35개 TypeScript 파일)
├── shared/                  # 공유 타입 정의
│   ├── schema.ts            # 공통 인터페이스 및 Zod 스키마
│   └── emailConditionTypes.ts
├── prisma/
│   ├── schema.prisma        # 데이터베이스 스키마 (32개 모델)
│   └── seed.ts              # 시드 데이터
├── uploads/                 # 업로드 파일 저장소
├── logs/                    # Winston 로그
├── package.json
├── tsconfig.json
├── vite.config.ts
└── tailwind.config.ts

[통계]
- Frontend TypeScript 파일: 104개
- Backend TypeScript 파일: 35개
- UI 컴포넌트: 50+ 개
- 페이지 컴포넌트: 29개
- API 엔드포인트: 123개
- 데이터베이스 모델: 32개

================================================================================
3. 프론트엔드 아키텍처
================================================================================

[라우팅 구조 - Wouter 기반]

주요 라우트 (29개):
/ → DashboardHomePage (메인 대시보드)
/login → LoginPage
/register → RegisterPage
/notices → HomePage (공지사항 목록)
/notices/:id → NoticeDetailPage
/dashboard → Dashboard (교육 대시보드)
/courses/:id → CoursePage
/courses/:id/content → CourseContent
/assessment/:courseId → AssessmentPage
/tbm → TbmPage (TBM 일지)
/team-management → TeamManagementPage
/safety-inspection → SafetyInspectionPage
/inspection-gallery → InspectionGalleryPage
/monthly-report → MonthlyReportPage
/approval/:approvalId → ApprovalPage
/approval-history → ApprovalHistoryPage
/admin → AdminPage
/admin-dashboard → AdminDashboardPage
/email-settings → EmailSettingsPage

라우트 보호 (RBAC):
- 공개 라우트: /, /login, /register, /notices
- ADMIN 전용: /admin, /checklist-editor, /education-management, /email-settings
- TEAM_LEADER + ADMIN: /team-management, /safety-inspection
- 인증 사용자: /profile, /my-certificates, /courses

[상태 관리 전략]

1. 서버 상태 (TanStack Query)
   - staleTime: Infinity (수동 갱신)
   - refetchOnWindowFocus: false
   - retry: false
   - 401 에러 처리: throw 또는 returnNull

2. 인증 상태 (React Context)
   interface AuthUser {
     id: string;
     username: string;
     name?: string | null;
     role: string;
     teamId?: number | null;
     site?: string | null;
   }

   - refreshUser(): 세션 확인 및 갱신
   - logout(): 로그아웃 및 리다이렉트
   - localStorage에 currentUserId 저장

3. UI 상태 (Zustand - 필요시)
   - 로컬 컴포넌트 상태는 useState/useReducer 사용

[API 통신 패턴]

apiRequest(method, url, data)
  - fetch() 사용
  - credentials: "include" (세션 쿠키 포함)
  - Content-Type: application/json
  - 에러 처리: throwIfResNotOk()

에러 처리:
- ErrorBoundary로 전역 에러 캐치
- Toast UI로 사용자 알림
- 401 에러 시 자동 로그인 페이지 리다이렉트

[컴포넌트 설계 패턴]

Atomic Design 접근:
components/ui/        # Atoms (Button, Input, Card, etc.)
components/          # Molecules (SignatureDialog, CourseCard, FileDropzone)
pages/               # Organisms/Templates

공통 유틸리티 (lib/utils.ts):
- cn(): TailwindCSS 클래스 병합 (clsx + tailwind-merge)
- stripSiteSuffix(): 팀명에서 사이트 접미사 제거
- getInspectionYearRange(): 안전점검용 연도 범위

상수 관리 (config/constants.ts):
- PROGRESS_SAVE_INTERVAL: 10000ms (교육 진행률 자동 저장)
- MAX_FILE_SIZE: 100MB
- API_TIMEOUT: 30000ms
- TOAST_DURATION: 3000ms
- DEFAULT_PAGE_SIZE: 20

================================================================================
4. 백엔드 아키텍처
================================================================================

[Express 서버 구조 - server/index.ts]

초기화 순서:
1. Express 앱 생성
2. 미들웨어 설정
   - express.json() / express.urlencoded()
   - PostgreSQL 세션 스토어 (connect-pg-simple)
   - Winston 로거 (HTTP 요청 로깅)
3. 라우트 등록 (routes.ts)
4. 에러 핸들러
5. Vite 개발 서버 연동 (개발 환경)
6. 이메일 서비스 초기화
7. Cron 스케줄러 시작 (프로덕션)
8. 서버 리스닝 (port 5001)

세션 설정:
{
  store: PgSession (PostgreSQL),
  tableName: 'user_sessions',
  secret: process.env.SESSION_SECRET,
  resave: false,
  saveUninitialized: false,
  cookie: {
    secure: false,        // 내부 HTTP 네트워크
    httpOnly: true,       // XSS 방지
    sameSite: 'lax',
    maxAge: 7일,
  },
  name: 'sessionId',
  rolling: true           // 활성 세션 유지
}

[API 설계 패턴 - 123개 엔드포인트]

인증 (Auth) - 4개:
POST /api/auth/register - 회원가입
POST /api/auth/login - 로그인
GET /api/auth/me - 현재 사용자 정보
POST /api/auth/logout - 로그아웃

사용자 관리 (Users) - 7개:
GET /api/users - 전체 사용자 목록 (ADMIN)
GET /api/users/:userId - 사용자 상세
POST /api/users - 사용자 생성 (ADMIN)
PUT /api/users/:userId - 사용자 수정
PUT /api/users/:userId/role - 역할 변경 (ADMIN)
PUT /api/users/:userId/site - 사이트 변경 (ADMIN)
DELETE /api/users/:userId - 사용자 삭제 (ADMIN)

팀 관리 (Teams) - 10개:
GET /api/teams - 전체 팀 목록
GET /api/teams/:teamId - 팀 상세 정보
GET /api/teams/:teamId/template - TBM 체크리스트 템플릿
GET /api/teams/:teamId/users - 팀 멤버 목록
POST /api/teams/:teamId/members - 팀원 추가
DELETE /api/teams/:teamId/members/:userId - 팀원 제거
PUT /api/teams/:teamId/leader - 팀장 지정
PUT /api/teams/:teamId/approver - 결재자 지정 (ADMIN)
GET /api/teams/:teamId/team-members - TeamMember 목록
POST /api/teams/:teamId/team-members - TeamMember 추가

안전점검 (Safety Inspections) - 7개:
GET /api/safety-inspections - 안전점검 목록
GET /api/safety-inspections/:inspectionId - 안전점검 상세
POST /api/safety-inspections - 안전점검 생성
PUT /api/safety-inspections/:inspectionId - 안전점검 수정
POST /api/safety-inspections/:inspectionId/items - 사진 업로드
DELETE /api/safety-inspections/items/:itemId - 사진 삭제
GET /api/teams/:teamId/inspection-template/:month - 월별 템플릿

결재 시스템 (Approvals) - 7개:
POST /api/approvals/request - 결재 요청
GET /api/approvals/pending - 대기 중 결재 목록
POST /api/approvals/:id/approve - 결재 승인
POST /api/approvals/:id/reject - 결재 반려
GET /api/approvals/:id - 결재 상세
GET /api/approvals/sent/list - 내가 요청한 결재
GET /api/approvals/received/list - 내가 승인할 결재

공지사항 (Notices) - 8개:
GET /api/notices - 공지사항 목록
GET /api/notices/:noticeId - 공지사항 상세
POST /api/notices/:noticeId/mark-read - 읽음 표시
POST /api/notices - 공지사항 작성 (ADMIN)
PUT /api/notices/:noticeId - 공지사항 수정 (ADMIN)
DELETE /api/notices/:noticeId - 공지사항 삭제 (ADMIN)
GET /api/notices/:noticeId/comments - 댓글 목록
POST /api/notices/:noticeId/comments - 댓글 작성

교육 관리 (Courses) - 15개:
GET /api/courses - 교육 과정 목록
GET /api/courses/:courseId - 교육 과정 상세
POST /api/courses - 교육 과정 생성 (ADMIN)
PUT /api/courses/:courseId - 교육 과정 수정 (ADMIN)
DELETE /api/courses/:courseId - 교육 과정 삭제 (ADMIN)
GET /api/courses/:courseId/progress - 사용자 진행률
POST /api/courses/:courseId/progress - 진행률 업데이트
GET /api/courses/:courseId/assessments - 평가 문제
POST /api/courses/:courseId/assessments/submit - 평가 제출
GET /api/users/:userId/certificates - 수료증 목록
POST /api/courses/:courseId/complete - 교육 완료

TBM 일지 (Reports) - 10개:
GET /api/reports - TBM 일지 목록
GET /api/reports/:reportId - TBM 일지 상세
POST /api/reports - TBM 일지 작성
PUT /api/reports/:reportId - TBM 일지 수정
DELETE /api/reports/:reportId - TBM 일지 삭제
POST /api/reports/:reportId/signatures - 서명 추가
GET /api/reports/monthly/:year/:month - 월별 보고서
POST /api/reports/export - 엑셀 내보내기

이메일 관리 (Email) - 10개:
GET /api/email/templates - 이메일 템플릿 목록
POST /api/email/templates - 템플릿 생성
PUT /api/email/templates/:id - 템플릿 수정
DELETE /api/email/templates/:id - 템플릿 삭제
GET /api/email/conditions - 이메일 조건 목록
POST /api/email/conditions - 조건 생성
PUT /api/email/conditions/:id - 조건 수정
DELETE /api/email/conditions/:id - 조건 삭제
POST /api/email/test - 테스트 이메일 발송
GET /api/email/logs - 발송 이력

파일 업로드 - 5개:
POST /api/upload/image - 이미지 업로드
POST /api/upload/document - 문서 업로드
POST /api/upload/video - 동영상 업로드
POST /api/upload/multiple - 다중 파일 업로드
GET /uploads/:filename - 파일 서빙

통계 및 대시보드 - 5개:
GET /api/dashboard/stats - 대시보드 통계
GET /api/admin/education-overview - 교육 현황
GET /api/admin/tbm-overview - TBM 현황
GET /api/admin/inspection-overview - 안전점검 현황
GET /api/admin/user-statistics - 사용자 통계

[미들웨어 체계]

인증 미들웨어:
- requireAuth: 로그인 필수 체크
- requireRole(...roles): 특정 역할 필수
- requireOwnership(userIdParam): 본인 또는 ADMIN만 접근

Rate Limiting:
- apiLimiter: 15분당 100회
- authLimiter: 15분당 5회 (로그인/회원가입)
- uploadLimiter: 1시간당 100회

파일 업로드 (Multer):
- 허용 파일 타입: jpeg, jpg, png, gif, webp, pdf, txt, csv, xlsx,
  docx, hwp, hwpx, mp4, webm, ogg, mov, avi, wmv
- 최대 크기: 100MB
- 최대 파일 수: 10개
- 저장 위치: server/uploads/

로깅 (Winston):
- 로그 레벨: error, warn, http, info, debug
- 전송: Console (개발), Daily Rotate File (프로덕션)
- 보존 기간: 14일
- 최대 크기: 20MB

[데이터베이스 연결 - Prisma]

db.ts - 싱글톤 패턴:
- 개발: 글로벌 변수로 인스턴스 재사용 (HMR 대응)
- 프로덕션: 매번 새 인스턴스
- 로그: 개발(query, error, warn), 프로덕션(error만)
- Graceful Shutdown: beforeExit, SIGINT, SIGTERM 처리

================================================================================
5. 데이터베이스 설계 (Prisma Schema - 32개 모델)
================================================================================

[1. 인증 및 사용자 관리]

User - 사용자 계정
  - id (uuid), username (unique), email (unique)
  - password (bcrypt hashed), role, site
  - teamId (외래키)
  - 관계: team, ledTeams, approverTeams, teamMemberProfile

UserSession - Express 세션 저장
  - sid (pk), sess (json), expire

[2. 팀 관리]

Factory - 공장 (아산, 화성)
  - id, name, code (ASAN/HWASEONG)

Team - 팀/라인
  - id, name, site, factoryId
  - leaderId (팀장), approverId (결재자)

TeamMember - 팀원 명단 (User 계정 없어도 가능)
  - id, teamId, userId (optional), name, position, isActive

TeamEquipment - 라인별 보유 장비
  - id, teamId, equipmentName, quantity

[3. TBM 일지 시스템]

ChecklistTemplate - TBM 체크리스트 템플릿
  - id, name, teamId

TemplateItem - 체크리스트 항목
  - id, templateId, category, subCategory, description, displayOrder

DailyReport - 일일 TBM 보고서
  - id, teamId, reportDate, managerName, remarks, site

ReportDetail - 보고서 상세 항목
  - id, reportId, itemId, checkState, actionDescription, actionStatus

ReportSignature - 서명 기록
  - id, reportId, userId (or memberId), signatureImage (base64)

AbsenceRecord - 부재 사유
  - id, memberId, reportId, absenceType, reason

MonthlyApproval - 월별 보고서
  - id, teamId, year, month, status, pdfUrl, approverId

[4. 안전점검 시스템]

InspectionTemplate - 팀별 월별 점검 템플릿
  - id, teamId, month (1-12), equipmentName, displayOrder

InspectionScheduleTemplate - 공장별 월별 점검 마스터
  - id, factoryId, month, equipmentName, displayOrder

MonthlyInspectionDay - 월별 점검일 관리
  - id, factoryId, month, inspectionDay (1-31)

SafetyInspection - 안전점검 기록
  - id, teamId, year, month, inspectionDate, isCompleted

InspectionItem - 점검 항목 (사진)
  - id, inspectionId, equipmentName, photos (JSON), remarks

[5. 결재 시스템]

ApprovalRequest - 결재 요청
  - id, reportId, requesterId, approverId, status
  - requestedAt, approvedAt, rejectionReason, executiveSignature

[6. 교육 시스템]

Course - 교육 과정
  - id, title, description, type, duration
  - videoUrl, videoType, audioUrl, documentUrl, color, icon

UserProgress - 사용자 진행률
  - id, userId, courseId, progress (0-100), completed
  - currentStep, timeSpent, lastAccessed

Assessment - 평가 문제
  - id, courseId, question, options (JSON), correctAnswer

UserAssessment - 평가 기록
  - id, userId, courseId, score, passed, attemptNumber

Certificate - 수료증
  - id, userId, courseId, certificateUrl, issuedAt

[7. 공지사항 시스템]

Notice - 공지사항
  - id, title, content, authorId, category, isActive
  - viewCount, imageUrl, videoUrl, videoType

NoticeRead - 공지 읽음 기록
  - id, noticeId, userId, readAt
  - 복합 유니크: (noticeId, userId)

Comment - 댓글
  - id, content, authorId, noticeId, imageUrl

[8. 첨부파일]

Attachment - 범용 첨부파일
  - id, url, name, type, size, mimeType
  - noticeId, commentId, reportDetailId, courseId
  - type: 'image' | 'file' | 'video' | 'youtube' | 'audio'

[9. 이메일 시스템]

EmailTemplate - 이메일 템플릿
  - id, name, type, subject, htmlContent, variables (JSON)

EmailSchedule - Cron 기반 자동 발송
  - id, name, templateId, cronExpression, isEnabled

EmailCondition - 조건부 발송
  - id, name, conditionType, parameters (JSON)
  - templateId, recipientType, recipientConfig

EmailSendLog - 발송 이력
  - id, conditionId, scheduleId, templateType
  - recipientId, recipientEmail, sentAt, status

[주요 인덱스 전략]

복합 인덱스:
- User: role+site (역할 및 사이트별 조회)
- DailyReport: teamId+reportDate (팀별 날짜 조회)
- SafetyInspection: teamId+year+month (팀별 월별 조회)

단일 인덱스:
- User: teamId, role, site
- Notice: authorId, createdAt, category
- DailyReport: teamId, reportDate, site
- EmailSendLog: recipientId, recipientEmail, sentAt

[관계 설계 특징]

User ↔ Team 다대다 관계:
- User.team (일반 소속 팀)
- User.ledTeams (내가 팀장인 팀들)
- User.approverTeams (내가 결재자인 팀들)

이중 팀원 시스템:
- User (로그인 계정 보유) ← teamId → Team
- TeamMember (계정 없는 팀원) ← teamId → Team
- TeamMember.userId (선택) → User (교육 진행률 추적용)

Cascade 삭제 전략:
- User 삭제 → Progress, Assessment, Certificate 삭제
- Team 삭제 → TeamMember, Equipment 삭제
- DailyReport 삭제 → ReportDetail, Signature 삭제
- SafetyInspection 삭제 → InspectionItem 삭제

================================================================================
6. 주요 기능 모듈 상세
================================================================================

[인증 시스템]

흐름:
1. 로그인 요청 (username, password)
2. bcrypt 비밀번호 검증
3. 세션 생성 및 PostgreSQL 저장
4. 쿠키 발급 (sessionId, httpOnly, 7일)
5. 클라이언트는 모든 요청에 쿠키 포함
6. 서버는 req.session.user로 인증 확인

역할 기반 접근 제어 (RBAC):
- ADMIN: 시스템 관리자
- TEAM_LEADER: 팀장/조장
- SITE_MANAGER: 현장관리자
- APPROVER: 임원/결재자

보안 조치:
- Rate Limiting: 로그인 15분당 5회
- bcrypt 해싱 (saltRounds: 10)
- httpOnly 쿠키 (XSS 방지)
- sameSite: 'lax' (CSRF 완화)
- Session rotation (rolling: true)

[안전교육 시스템]

교육 과정 구조:
Course (과정 정보)
├── 비디오/음성/문서 자료
├── Assessment (평가 문제)
├── UserProgress (진행률)
└── Certificate (수료증)

진행률 관리:
- progress = (timeSpent / duration) * 100
- 자동 저장: 10초마다
- 완료 조건: currentStep === 3 && progress === 100

평가 시스템:
1. 교육 완료 후 평가 문제 풀이
2. 점수 계산
3. 합격 기준: 80% 이상
4. 불합격 시 재응시 가능
5. 합격 시 Certificate 자동 발급

[TBM (Tool Box Meeting) 시스템]

체크리스트 구조:
ChecklistTemplate → TemplateItem[]
  - category: 대분류
  - subCategory: 중분류
  - description: 점검 내용

일일 TBM 작성:
1. 팀 선택
2. ChecklistTemplate 로드
3. 각 항목에 대해 ReportDetail 작성
   - checkState: '양호' | '불량' | '해당없음'
   - actionDescription: 조치 내용
   - attachments: 사진 첨부
4. 팀원 서명 수집
5. DailyReport 저장

월별 보고서 생성:
1. 해당 월의 모든 DailyReport 조회
2. 통계 집계
3. PDF 생성
4. MonthlyApproval 생성 (DRAFT)
5. 팀장 결재 요청 → SUBMITTED
6. 임원 승인 → APPROVED

[안전점검 시스템]

점검 프로세스:
1. 공장별 월별 점검일 설정
2. 공장별 점검 항목 마스터 관리
3. 팀별 월별 템플릿 생성
4. 점검일에 SafetyInspection 생성
5. 각 장비별 사진 업로드
6. 모든 사진 업로드 완료 시 isCompleted = true

장비 관리:
TeamEquipment
- equipmentName: "지게차", "크레인" 등
- quantity: 보유 개수
→ 점검 시 해당 개수만큼 사진 요구

[결재 시스템]

결재 흐름:
1. 팀장: MonthlyApproval 작성 완료
2. 팀장: ApprovalRequest 생성
3. 임원: 대기 목록 조회
4. 임원: 보고서 검토
5. 임원: 승인 또는 반려
6. 이메일 자동 발송

상태 관리:
MonthlyApproval.status:
- DRAFT: 작성 중
- SUBMITTED: 결재 요청됨
- APPROVED: 승인됨
- REJECTED: 반려됨

[이메일 시스템]

템플릿 엔진:
subject: "[{{siteName}}] {{userName}}님, 교육 알림"
htmlContent: 변수 {{변수명}} 형식 지원

조건부 발송:
- TBM_NOT_SUBMITTED_DAYS: TBM N일 미작성
- MONTHLY_REPORT_COMPLETED: 월간보고서 완료
- EDUCATION_OVERDUE: 교육 기한 초과
- SAFETY_INSPECTION_DUE: 안전점검 마감 임박
- APPROVAL_PENDING_DAYS: 결재 N일 대기

스케줄 발송:
- 매일 오전 7시: 교육 미이수자 알림
- 매일 오전 8시: TBM 미작성 알림
- 매월 1일: 안전점검 알림

중복 발송 방지:
- 24시간 이내 동일 조건/수신자 재발송 금지

[파일 업로드 시스템]

Multer 설정:
- 저장 위치: server/uploads/
- 파일 크기 제한: 100MB
- 파일 개수 제한: 10개
- 파일 타입 검증: MIME 타입 + 확장자

이미지 최적화 (Sharp):
- 리사이징 (최대 2000px)
- 포맷 변환 (JPEG, PNG, WebP)
- 메타데이터 제거
- 압축 (quality: 80)

드래그 앤 드롭 (FileDropzone):
- react-dropzone 라이브러리
- 적용 위치: 6개 파일, 9곳
  1. 공지사항 작성 - 이미지, 파일
  2. 공지사항 댓글 - 이미지, 파일
  3. 교육 과정 관리 - 문서
  4. 교육 과정 편집 - 문서
  5. 안전점검 - 사진
  6. TBM 체크리스트 - 사진/영상 (2곳)

================================================================================
7. 설계 패턴 및 규칙
================================================================================

[코딩 컨벤션]

TypeScript:
- 모든 신규 코드는 TypeScript
- any 타입 금지 (불가피한 경우 주석 필수)
- interface 우선 (type은 유니온/교차 타입)
- 함수형 컴포넌트 + Hooks

네이밍:
- 컴포넌트: PascalCase (LoginPage, TeamManagementPage)
- 함수: camelCase (fetchUserData, calculateProgress)
- 상수: UPPER_SNAKE_CASE (MAX_FILE_SIZE, API_TIMEOUT)
- 파일명: 컴포넌트(PascalCase.tsx), 유틸리티(camelCase.ts)

주석:
- 비즈니스 로직: 한글
- 기술적 설명: 영어

[API 설계 패턴]

RESTful 규칙:
GET /api/resources - 목록 조회
GET /api/resources/:id - 단일 조회
POST /api/resources - 생성
PUT /api/resources/:id - 수정
DELETE /api/resources/:id - 삭제

응답 형식:
성공: { data: {...}, message: "성공" }
실패: { message: "에러 메시지" }

페이지네이션:
Query: ?page=1&limit=20
Response: { data: [...], total, page, limit }

[에러 핸들링]

클라이언트:
try {
  await apiRequest('POST', '/api/...', data);
  toast.success('성공');
} catch (error) {
  toast.error(error.message);
}

서버:
try {
  // 비즈니스 로직
} catch (error) {
  logger.error('에러', { error });
  res.status(500).json({ message: '오류' });
}

[데이터 검증]

Zod 스키마 (shared/schema.ts):
export const insertUserSchema = z.object({
  username: z.string().min(2),
  email: z.string().email(),
  password: z.string().min(8),
});

React Hook Form:
const form = useForm({
  resolver: zodResolver(schema),
  defaultValues: {...}
});

================================================================================
8. 데이터 흐름
================================================================================

[사용자 요청 플로우]

Browser
  ↓ HTTP Request (sessionId cookie)
Express Middleware Chain
  1. express.json() - JSON 파싱
  2. express-session - 세션 복원
  3. Winston Logger - 요청 로깅
  4. requireAuth - 인증 체크
  5. requireRole - 권한 체크
  6. rateLimit - Rate limiting
  ↓
Route Handler
  - req.session.user로 사용자 정보 확인
  - Zod 검증
  ↓
Prisma Client
  - prisma.model.operation
  - Transaction 처리
  ↓
Response
  - res.json({ data, message })
  - Winston 로거
  ↓
Browser
  - TanStack Query 캐싱
  - UI 업데이트

[상태 관리 흐름]

서버 상태 (TanStack Query):
const { data } = useQuery({
  queryKey: ['/api/teams'],
  queryFn: getQueryFn({ on401: 'throw' })
});

const mutation = useMutation({
  mutationFn: async (data) => apiRequest(...),
  onSuccess: () => queryClient.invalidateQueries(...)
});

인증 상태 (Context):
App 시작 → refreshUser() → GET /api/auth/me → setUser()
로그아웃 → logout() → POST /api/auth/logout → setUser(null)

[파일 업로드 플로우]

Client
  1. <input type="file"> 또는 FileDropzone
  2. FormData 생성
  3. fetch('/api/upload/...', { body: formData })
  ↓
Server - Multer
  1. 파일 검증
  2. server/uploads/ 저장
  ↓
Server - Sharp (이미지)
  1. 리사이징
  2. 최적화
  ↓
Server - Prisma
  1. Attachment 생성
  2. 부모 엔티티 연결
  ↓
Response
  { url: '/uploads/...', id: '...' }
  ↓
Client
  - 이미지 표시 또는 다운로드 링크

================================================================================
9. 주요 파일 설명
================================================================================

server/index.ts
- 역할: Express 서버 엔트리 포인트
- 기능: 미들웨어 설정, 라우트 등록, 이메일 서비스 초기화,
       Cron 스케줄러 시작, 서버 리스닝

server/routes.ts
- 역할: API 라우트 정의 (6027줄, 123개 엔드포인트)
- 특징: 모든 API 집중 관리, RBAC, Zod 검증, Prisma 트랜잭션

server/db.ts
- 역할: Prisma Client 싱글톤
- 특징: HMR 대응 (개발), Graceful shutdown

client/src/main.tsx
- 역할: React 엔트리 포인트
- 기능: ReactDOM.createRoot

client/src/App.tsx
- 역할: 라우팅 및 Provider 설정
- 기능: ErrorBoundary, AuthProvider, QueryClientProvider,
       Switch/Route (29개 라우트)

prisma/schema.prisma
- 역할: 데이터베이스 스키마 (616줄, 32개 모델)
- 특징: 명확한 관계, 복합 인덱스, Cascade 삭제, JSON 필드

shared/schema.ts
- 역할: 프론트-백 공유 타입
- 기능: Enum, Interface, Zod Schema
- 이점: 타입 안전성, 중복 제거

================================================================================
10. 배포 및 운영
================================================================================

[환경 변수 (.env)]

# Database
DATABASE_URL=postgresql://user:password@localhost:5432/foodiematch

# Server
PORT=5001
NODE_ENV=production
SESSION_SECRET=your-secret-key

# Email (SMTP)
SMTP_HOST=smtp.company.com
SMTP_PORT=25
SMTP_USER=noreply@company.com
SMTP_PASSWORD=password

# Features
ENABLE_EMAIL_SCHEDULERS=true
BASE_URL=https://safety.company.com

[빌드 및 실행]

개발 모드:
cd FoodieMatch
npm install
npm run dev  # Port 5001

프로덕션:
npm run build
npm start

[데이터베이스]

스키마 변경:
npm run db:push  # Prisma push
또는
npx prisma migrate dev --name migration_name

시드 데이터:
npx prisma db seed

[로그 관리]

Winston 로그:
logs/app-2025-11-21.log  # 전체
logs/error-2025-11-21.log  # 에러

로그 레벨: error, warn, http, info, debug

================================================================================
11. 보안 고려사항
================================================================================

인증 및 권한:
- Session-based 인증 (PostgreSQL 저장)
- httpOnly 쿠키 (XSS 방지)
- RBAC (4개 역할)
- bcrypt 해싱
- Rate Limiting

입력 검증:
- Zod 스키마 검증
- Multer 파일 타입 검증
- XSS 방지 (dompurify)
- SQL Injection 방지 (Prisma)

CSRF 방지:
- sameSite: 'lax' 쿠키

파일 업로드 보안:
- 파일 크기 제한 (100MB)
- 허용된 MIME 타입만
- 확장자 검증
- 업로드 디렉토리 제한

================================================================================
12. 성능 최적화
================================================================================

데이터베이스:
- 적절한 인덱스
- Prisma 쿼리 최적화
- 페이지네이션
- Connection pooling

프론트엔드:
- TanStack Query 캐싱
- Code splitting (Vite lazy loading)
- 이미지 최적화 (Sharp)
- Debounce/Throttle

API:
- Rate Limiting
- 압축 (gzip)
- Static file serving
- 로그 로테이션

================================================================================
13. 확장성 및 유지보수
================================================================================

모듈화:
- 기능별 디렉토리
- 공유 타입 (shared/)
- 재사용 컴포넌트
- 유틸리티 함수

타입 안전성:
- TypeScript 엄격 모드
- Prisma 타입 자동 생성
- Zod 런타임 검증
- shared/schema.ts

코드 품질:
- ESLint
- TypeScript 컴파일 체크
- 명확한 네이밍
- 주석

문서화:
- README 파일들
- 코드 주석
- Prisma 스키마 주석
- API 엔드포인트 주석

================================================================================
14. Git 워크플로우
================================================================================

커밋 메시지 컨벤션:
feat: 새 기능
fix: 버그 수정
docs: 문서 수정
style: 코드 스타일
refactor: 리팩토링
test: 테스트
chore: 기타

코드 리뷰 체크리스트:
□ TypeScript 컴파일 통과
□ 타입 안전성
□ 에러 핸들링
□ 인증/권한 체크
□ 입력 검증
□ 로깅
□ 주석
□ 테스트

================================================================================
15. 프로젝트 통계
================================================================================

코드 라인:
- server/routes.ts: 6027줄
- prisma/schema.prisma: 616줄
- Frontend 파일: 104개
- Backend 파일: 35개

데이터:
- 데이터베이스 모델: 32개
- API 엔드포인트: 123개
- UI 컴포넌트: 50+ 개
- 페이지: 29개

기능:
- 인증 시스템: ✓
- 안전교육: ✓
- TBM 일지: ✓
- 안전점검: ✓
- 결재 시스템: ✓
- 이메일 시스템: ✓
- 파일 업로드: ✓
- 통계 대시보드: ✓

================================================================================
결론
================================================================================

FoodieMatch는 안전관리 플랫폼의 모든 기능을 통합한 종합 시스템입니다.

핵심 특징:
- 32개 데이터 모델
- 123개 RESTful API
- 29개 페이지
- 4개 역할 RBAC
- 실시간 이메일 알림
- 드래그 앤 드롭 파일 업로드
- 교육, TBM, 안전점검, 결재 통합

기술적 강점:
- TypeScript 타입 안전성
- Prisma ORM
- TanStack Query 상태 관리
- Winston 로깅
- Rate Limiting
- 확장 가능한 모듈 구조

이 문서를 통해 다른 개발자나 AI가 프로젝트의 전체 구조와 설계를
이해하고, 효과적으로 유지보수 및 확장 개발을 수행할 수 있습니다.

================================================================================
문서 작성일: 2025-11-21
문서 버전: 1.0
작성자: Claude Code
================================================================================
