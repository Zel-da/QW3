# 나온 소프트 그룹웨어 이메일 연동 가이드

## 1. 나온 소프트 SMTP 설정 방법

### 1.1 나온 소프트 관리자 페이지 접속
1. 나온 소프트 그룹웨어 관리자 페이지 로그인
2. **환경설정** > **메일 설정** 메뉴 진입
3. **SMTP 서버 설정** 확인

### 1.2 필요한 정보 확인
나온 소프트에서 다음 정보를 확인하세요:

```
□ SMTP 서버 주소: _____________________
□ SMTP 포트: _____________________
□ 보안 연결: TLS / SSL / 없음
□ 인증 필요 여부: 예 / 아니오
```

### 1.3 발신 전용 계정 생성 (권장)
시스템 자동 발송용 계정을 별도로 생성하는 것을 권장합니다:

**예시:**
- 이메일: safety-system@company.com
- 표시명: 안전보건팀
- 용도: 시스템 자동 발송 전용

## 2. 환경변수 설정

### 2.1 .env 파일 생성
프로젝트 루트에 `.env` 파일을 생성하고 다음 내용을 입력하세요:

```bash
# 나온 소프트 SMTP 설정
SMTP_HOST="smtp.naonsoft.com"           # 나온 소프트 SMTP 서버
SMTP_PORT="587"                         # 587(TLS) 또는 465(SSL)
SMTP_USER="safety-system@company.com"   # 발신 계정
SMTP_PASSWORD="your-password-here"      # 계정 비밀번호
SMTP_FROM="안전보건팀 <safety-system@company.com>"

# 기본 URL (메일 링크용)
BASE_URL="http://your-server-ip:5173"
```

### 2.2 보안 설정
`.env` 파일은 절대 Git에 커밋하지 마세요!

```bash
# .gitignore에 추가되어 있는지 확인
echo ".env" >> .gitignore
```

## 3. 연결 테스트

### 3.1 서버 시작 시 자동 테스트
서버를 시작하면 자동으로 SMTP 연결을 테스트합니다:

```bash
cd FoodieMatch
npm run dev
```

**성공 메시지:**
```
✅ Email service is ready
```

**실패 메시지:**
```
❌ Email service error: [에러 내용]
```

### 3.2 수동 테스트 (Node.js 콘솔)
```javascript
// test-email.js 파일 생성
import { sendEmail, verifyEmailConnection } from './server/emailService.js';

// 1. 연결 테스트
const isConnected = await verifyEmailConnection();
console.log('연결 상태:', isConnected);

// 2. 테스트 메일 발송
const result = await sendEmail({
  to: 'test@company.com',
  subject: '테스트 메일',
  html: '<h1>연결 테스트 성공!</h1>'
});
console.log('발송 결과:', result);
```

```bash
# 실행
node test-email.js
```

## 4. 일반적인 오류 해결

### 4.1 연결 시간 초과 (ETIMEDOUT)
**원인:** 방화벽에서 SMTP 포트 차단

**해결:**
1. IT팀에 방화벽 오픈 요청
2. 포트 587 (TLS) 또는 465 (SSL) 허용 요청

### 4.2 인증 실패 (Authentication failed)
**원인:** 계정 정보 오류 또는 권한 부족

**해결:**
1. SMTP_USER, SMTP_PASSWORD 확인
2. 나온 소프트에서 SMTP 인증 허용 설정 확인
3. 앱 비밀번호 사용 여부 확인

### 4.3 TLS 오류
**원인:** 자체 서명 인증서 사용

**현재 설정:**
```javascript
tls: {
  rejectUnauthorized: false,  // 이미 설정됨
  minVersion: 'TLSv1'
}
```

## 5. 나온 소프트 특화 설정

### 5.1 나온 소프트 API 연동 (선택사항)
SMTP 대신 나온 소프트 REST API를 사용하는 방법:

```javascript
// API 방식 (SMTP 사용 불가 시 대안)
async function sendEmailViaAPI(options) {
  const response = await fetch('https://api.naonsoft.com/v1/mail/send', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${process.env.NAONSOFT_API_KEY}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      to: options.to,
      subject: options.subject,
      html: options.html
    })
  });
  return response.json();
}
```

### 5.2 대량 발송 제한
나온 소프트에 발송 제한이 있을 수 있습니다. 확인 필요 사항:

```
□ 시간당 발송 제한: _____ 건
□ 일일 발송 제한: _____ 건
□ 수신자 수 제한: _____ 명
```

## 6. 운영 환경 배포

### 6.1 환경변수 설정
운영 서버에 환경변수를 설정하세요:

**Windows:**
```cmd
set SMTP_HOST=smtp.naonsoft.com
set SMTP_PORT=587
set SMTP_USER=safety-system@company.com
set SMTP_PASSWORD=your-password
```

**Linux:**
```bash
export SMTP_HOST=smtp.naonsoft.com
export SMTP_PORT=587
export SMTP_USER=safety-system@company.com
export SMTP_PASSWORD=your-password
```

### 6.2 프로세스 매니저 설정 (PM2)
```json
// ecosystem.config.js
module.exports = {
  apps: [{
    name: 'safety-system',
    script: 'server/index.ts',
    env: {
      NODE_ENV: 'production',
      SMTP_HOST: 'smtp.naonsoft.com',
      SMTP_PORT: '587',
      SMTP_USER: 'safety-system@company.com',
      SMTP_PASSWORD: 'your-password',
      SMTP_FROM: '안전보건팀 <safety-system@company.com>',
      BASE_URL: 'http://your-server:5173'
    }
  }]
};
```

## 7. 모니터링 및 로깅

### 7.1 발송 로그 확인
모든 메일 발송은 자동으로 로그에 기록됩니다:

```
✅ Email sent: <message-id>
❌ Email send error: [에러 내용]
```

### 7.2 실패 알림 설정 (선택사항)
메일 발송 실패 시 관리자에게 알림을 보내는 기능:

```javascript
// routes.ts에 추가
if (!result.success) {
  // 관리자에게 알림
  await sendEmail({
    to: 'admin@company.com',
    subject: '[시스템] 메일 발송 실패',
    html: `메일 발송 실패: ${result.error}`
  });
}
```

## 8. 체크리스트

설정 완료 후 다음 항목을 확인하세요:

### 설정 확인
- [ ] `.env` 파일 생성 및 SMTP 정보 입력
- [ ] 서버 시작 시 "Email service is ready" 메시지 확인
- [ ] 테스트 메일 발송 성공

### 기능 테스트
- [ ] 안전교육 알림 메일 테스트
- [ ] TBM 작성 알림 메일 테스트
- [ ] 안전점검 알림 메일 테스트
- [ ] 결재 알림 메일 테스트

### 보안 확인
- [ ] `.env` 파일이 `.gitignore`에 포함되어 있음
- [ ] 운영 서버 환경변수 안전하게 저장됨
- [ ] SMTP 계정 비밀번호 강력함

### 운영 준비
- [ ] IT팀과 SMTP 설정 협의 완료
- [ ] 방화벽 오픈 완료
- [ ] 발송 제한 확인 완료
- [ ] 모니터링 체계 구축 완료

---

**작성일:** 2025년 11월 6일
**버전:** 1.0
**문의:** 안전보건팀
