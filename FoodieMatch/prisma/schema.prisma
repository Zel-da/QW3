generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                     String            @id @default(uuid())
  username               String            @unique
  name                   String?
  email                  String?           @unique
  password               String?
  role                   String            @default("PENDING")
  site                   String?
  sites                  String?           // 다중 사이트 접근 ("화성,아산")
  teamId                 Int?
  createdAt              DateTime          @default(now())
  team                   Team?             @relation("TeamMembers", fields: [teamId], references: [id])
  ledTeams               Team[]            @relation("TeamLeader")
  approverTeams          Team[]            @relation("TeamApprover")      // 신규: 내가 결재자인 팀들
  teamMemberProfile      TeamMember?       @relation("TeamMemberUser")    // 신규: TeamMember 프로필 연결
  notices                Notice[]
  createdApprovals       MonthlyApproval[] @relation("Approver")
  signatures             ReportSignature[]
  comments               Comment[]
  reportDetails          ReportDetail[]
  requestedApprovals     ApprovalRequest[] @relation("ApprovalRequester") // 신규: 내가 요청한 결재
  approvalsToApprove     ApprovalRequest[] @relation("ApprovalApprover")  // 신규: 내가 승인할 결재
  userProgress           UserProgress[]    // 사용자의 교육 진행 상황
  userAssessments        UserAssessment[]  // 사용자의 평가 기록
  certificates           Certificate[]     // 사용자의 수료증
  noticeReads            NoticeRead[]      // 사용자가 읽은 공지사항
  failedLoginAttempts    Int               @default(0)   // 로그인 실패 횟수
  lockedUntil            DateTime?                       // 계정 잠금 해제 시간
  passwordResetTokens    PasswordResetToken[]            // 비밀번호 재설정 토큰
  auditLogs              AuditLog[]        @relation("AuditLogUser") // 감사 로그

  @@index([teamId])
  @@index([role])
  @@index([site])
  @@index([role, site])
  @@map("User")
}

// 비밀번호 재설정 토큰
model PasswordResetToken {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
}

model Notice {
  id             String       @id @default(uuid())
  title          String
  content        String
  authorId       String
  category       String       @default("GENERAL")
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  isActive       Boolean      @default(true)
  viewCount      Int          @default(0)
  imageUrl       String?
  attachmentUrl  String?
  attachmentName String?
  videoUrl       String?      // 신규: 동영상 URL (mp4 파일 또는 유튜브)
  videoType      String?      // 신규: 'file' | 'youtube'
  author         User         @relation(fields: [authorId], references: [id], onDelete: Cascade)
  comments       Comment[]
  attachments    Attachment[]
  noticeReads    NoticeRead[] // 이 공지를 읽은 사용자들

  @@index([authorId])
  @@index([createdAt])
  @@index([category])
  @@index([category, createdAt])
}

model NoticeRead {
  id        String   @id @default(uuid())
  noticeId  String
  userId    String
  readAt    DateTime @default(now())
  notice    Notice   @relation(fields: [noticeId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([noticeId, userId])
  @@index([userId])
  @@index([noticeId])
  @@index([readAt])
  @@map("NoticeReads")
}

model Comment {
  id          String       @id @default(uuid())
  content     String
  imageUrl    String?
  authorId    String
  noticeId    String
  createdAt   DateTime     @default(now())
  author      User         @relation(fields: [authorId], references: [id], onDelete: Cascade)
  notice      Notice       @relation(fields: [noticeId], references: [id], onDelete: Cascade)
  attachments Attachment[]

  @@index([authorId])
  @@index([noticeId])
}

model Course {
  id              String           @id @default(uuid())
  title           String
  description     String
  type            String
  duration        Int
  videoUrl        String?
  videoType       String?          // 신규: 'youtube' | 'file' | 'audio'
  audioUrl        String?          // 신규: 음성 파일 URL
  documentUrl     String?
  color           String           @default("blue")
  icon            String
  isActive        Boolean          @default(true)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @default(now()) @updatedAt
  assessments     Assessment[]
  certificates    Certificate[]
  userAssessments UserAssessment[]
  userProgress    UserProgress[]
  attachments     Attachment[]     // 여러 미디어 파일 지원
}

model UserProgress {
  id           String   @id @default(uuid())
  userId       String
  courseId     String
  progress     Int      @default(0)
  completed    Boolean  @default(false)
  currentStep  Int      @default(1)
  timeSpent    Int      @default(0)
  lastAccessed DateTime @default(now())
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  course       Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([courseId])
  @@index([userId, courseId]) // 복합 인덱스: 사용자별 코스 진행률 조회 최적화
}

model Assessment {
  id            String @id @default(uuid())
  courseId      String
  question      String
  options       String
  correctAnswer Int
  difficulty    String @default("medium")
  course        Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@index([courseId])
}

model UserAssessment {
  id             String   @id @default(uuid())
  userId         String
  courseId       String
  score          Int
  totalQuestions Int
  passed         Boolean
  attemptNumber  Int      @default(1)
  completedAt    DateTime @default(now())
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  course         Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([courseId])
}

model Certificate {
  id                String   @id @default(uuid())
  userId            String
  courseId          String
  certificateNumber String   @unique  // 수료증 번호: CERT-YYYYMMDD-courseId-index
  certificateUrl    String
  score             Int?              // 평가 점수
  issuedAt          DateTime @default(now())
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  course            Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])  // 사용자당 과정별 수료증 1개만
  @@index([userId])
  @@index([courseId])
}

// 공장 (아산공장, 화성공장)
model Factory {
  id                    Int                             @id @default(autoincrement())
  name                  String                          // "아산공장", "화성공장"
  code                  String                          @unique // "ASAN", "HWASEONG"
  createdAt             DateTime                        @default(now())
  teams                 Team[]
  scheduleTemplates     InspectionScheduleTemplate[]
  monthlyInspectionDays MonthlyInspectionDay[]

  @@index([code])
  @@map("Factories")
}

model Team {
  id                  Int                   @id @default(autoincrement())
  name                String
  site                String?
  factoryId           Int?                  // 신규: 공장 ID
  leaderId            String?
  approverId          String?               // 신규: 월별보고서 결재자
  factory             Factory?              @relation(fields: [factoryId], references: [id], onDelete: SetNull)
  leader              User?                 @relation("TeamLeader", fields: [leaderId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  approver            User?                 @relation("TeamApprover", fields: [approverId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  members             User[]                @relation("TeamMembers")
  teamMembers         TeamMember[]          // 신규: User 계정 없는 팀원들
  checklistTemplates  ChecklistTemplate[]
  dailyReports        DailyReport[]
  monthlyApprovals    MonthlyApproval[]
  inspectionTemplates InspectionTemplate[]  // 신규: 안전점검 템플릿
  safetyInspections   SafetyInspection[]    // 신규: 안전점검 기록
  teamEquipments      TeamEquipment[]       // 신규: 라인별 보유 장비

  @@index([factoryId])
  @@map("Teams")
}

/// 팀원 명단 (TeamMember)
/// User 계정 없이도 팀장이 직접 관리할 수 있는 팀원 목록입니다.
/// User.members (Team.members): User 계정이 있는 팀원 (로그인 가능)
/// TeamMember: User 계정 없이 팀장이 추가한 팀원 (로그인 불가, 명단만)
/// userId가 있으면 User와 연결되어 교육 진행률 추적이 가능합니다.
model TeamMember {
  id               Int               @id @default(autoincrement())
  teamId           Int
  userId           String?           @unique // User 계정 연결 (선택적) - 교육 진행률 추적용
  name             String            // 팀원 이름
  position         String?           // 직책
  isActive         Boolean           @default(true)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  team             Team              @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user             User?             @relation("TeamMemberUser", fields: [userId], references: [id], onDelete: SetNull)
  reportSignatures ReportSignature[]
  absenceRecords   AbsenceRecord[]

  @@index([teamId])
  @@index([teamId, isActive])
  @@index([userId])
  @@map("TeamMembers")
}

// 신규 모델: 라인별 보유 장비
model TeamEquipment {
  id            Int      @id @default(autoincrement())
  teamId        Int
  equipmentName String   // "지게차", "크레인", "전단기" 등
  quantity      Int      // 보유 개수
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  team          Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([teamId, equipmentName])
  @@index([teamId])
  @@map("TeamEquipments")
}

// 신규 모델: 부재 사유 기록
model AbsenceRecord {
  id          Int         @id @default(autoincrement())
  memberId    Int
  reportId    Int
  absenceType String      // '연차', '반차', '출장', '교육', '기타'
  reason      String?     // 기타 사유
  createdAt   DateTime    @default(now())
  member      TeamMember  @relation(fields: [memberId], references: [id], onDelete: Cascade)
  report      DailyReport @relation(fields: [reportId], references: [id], onDelete: Cascade)

  @@index([memberId])
  @@index([reportId])
  @@map("AbsenceRecords")
}

/// TBM (Tool Box Meeting) 일지 템플릿
/// 팀별 일일 TBM 체크리스트 항목을 정의합니다.
/// 매일 작업 전 안전회의에서 사용되는 점검표 양식입니다.
model ChecklistTemplate {
  id            Int            @id @default(autoincrement())
  name          String
  teamId        Int
  team          Team           @relation(fields: [teamId], references: [id], onDelete: Cascade)
  templateItems TemplateItem[]

  @@index([teamId])
  @@map("ChecklistTemplates")
}

model TemplateItem {
  id           Int               @id @default(autoincrement())
  templateId   Int
  category     String
  subCategory  String?
  description  String
  displayOrder Int               @default(0)
  template     ChecklistTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  reportDetails ReportDetail[]

  @@index([templateId])
  @@map("TemplateItems")
}

/// TBM 일일 보고서 (DailyReport)
/// 매일 작업 전 안전회의(TBM) 체크리스트 작성 기록입니다.
/// ChecklistTemplate의 항목을 기반으로 일일 점검 결과를 저장합니다.
/// 월별 보고서는 이 DailyReport들을 집계하여 생성됩니다.
model DailyReport {
  id               Int               @id @default(autoincrement())
  teamId           Int
  reportDate       DateTime
  managerName      String?
  remarks          String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  site             String?
  team             Team              @relation(fields: [teamId], references: [id], onDelete: NoAction)
  reportDetails    ReportDetail[]
  reportSignatures ReportSignature[]
  absenceRecords   AbsenceRecord[]   // 신규: 부재 사유 기록

  @@index([teamId])
  @@index([reportDate])
  @@index([site])
  @@index([teamId, reportDate])
  @@index([site, reportDate])
  @@map("DailyReports")
}

model ReportDetail {
  id                Int           @id @default(autoincrement())
  reportId          Int
  itemId            Int
  checkState        String?
  authorId          String?
  actionDescription String?
  actionStatus      String?       @default("PENDING")
  item              TemplateItem  @relation(fields: [itemId], references: [id], onDelete: Cascade)
  report            DailyReport   @relation(fields: [reportId], references: [id], onDelete: Cascade)
  author            User?         @relation(fields: [authorId], references: [id])
  attachments       Attachment[]

  @@index([reportId])
  @@index([itemId])
  @@index([authorId])
  @@index([reportId, itemId]) // 복합 인덱스: 리포트별 항목 조회 최적화
  @@map("ReportDetails")
}

model ReportSignature {
  id             Int         @id @default(autoincrement())
  reportId       Int
  userId         String?     // User 계정이 있는 경우 (관리자용)
  memberId       Int?        // TeamMember (일반 팀원용) - userId와 memberId 중 하나만 사용
  signedAt       DateTime    @default(now())
  signatureImage String?
  report         DailyReport @relation(fields: [reportId], references: [id], onDelete: Cascade)
  user           User?       @relation(fields: [userId], references: [id], onDelete: Cascade)
  member         TeamMember? @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([reportId])
  @@index([userId])
  @@index([memberId])
  @@map("ReportSignatures")
}

model MonthlyApproval {
  id              String           @id @default(uuid())
  teamId          Int
  year            Int
  month           Int
  status          String           @default("DRAFT")
  pdfUrl          String?
  approverId      String?
  submittedAt     DateTime?
  approvedAt      DateTime?
  team            Team             @relation(fields: [teamId], references: [id])
  approver        User?            @relation("Approver", fields: [approverId], references: [id], onDelete: SetNull)
  approvalRequest ApprovalRequest? // 신규: 결재 요청

  @@unique([teamId, year, month])
  @@index([teamId])
  @@index([approverId])
  @@index([approverId, status]) // 복합 인덱스: 승인자별 상태 조회 최적화
}

// 신규 모델: 결재 요청 및 승인
model ApprovalRequest {
  id                 String          @id @default(uuid())
  reportId           String          @unique
  requesterId        String          // 요청자 (팀관리자)
  approverId         String          // 승인자 (임원)
  status             String          @default("PENDING") // PENDING, APPROVED, REJECTED
  requestedAt        DateTime        @default(now())
  approvedAt         DateTime?
  rejectionReason    String?         // 반려 사유
  executiveSignature String?         // 임원 서명 이미지 (base64)
  monthlyReport      MonthlyApproval @relation(fields: [reportId], references: [id], onDelete: Cascade)
  requester          User            @relation("ApprovalRequester", fields: [requesterId], references: [id])
  approver           User            @relation("ApprovalApprover", fields: [approverId], references: [id])

  @@index([requesterId])
  @@index([approverId])
  @@index([status])
  @@index([requestedAt])
  @@index([status, approverId]) // 복합 인덱스: 상태별 승인자 조회 최적화
  @@map("ApprovalRequests")
}

model Attachment {
  id             String        @id @default(uuid())
  url            String
  name           String
  type           String        @default("file") // 'image' | 'file' | 'video' | 'youtube' | 'audio'
  size           Int           @default(0)
  mimeType       String        @default("application/octet-stream")
  rotation       Int           @default(0) // 이미지 회전 각도 (0, 90, 180, 270)
  createdAt      DateTime      @default(now())
  noticeId       String?
  notice         Notice?       @relation(fields: [noticeId], references: [id], onDelete: Cascade)
  commentId      String?
  comment        Comment?      @relation(fields: [commentId], references: [id], onDelete: Cascade)
  reportDetailId Int?
  reportDetail   ReportDetail? @relation(fields: [reportDetailId], references: [id], onDelete: Cascade)
  courseId       String?
  course         Course?       @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@index([noticeId])
  @@index([commentId])
  @@index([reportDetailId])
  @@index([courseId])
}

// ========== 안전점검 시스템 ==========

/// 안전점검 템플릿 (InspectionTemplate)
/// 팀별, 월별로 매월 4일에 점검할 장비 목록을 정의합니다.
/// TBM 일지(DailyReport)와는 다르게, 월 1회 실시하는 정기 안전점검용입니다.
/// 실제 점검 기록은 SafetyInspection 모델에 저장됩니다.
model InspectionTemplate {
  id           Int     @id @default(autoincrement())
  teamId       Int
  month        Int     @default(1)  // 1-12 (월별 구분)
  equipmentName String  // 점검할 기기명 (예: 지게차, 크레인 등)
  displayOrder Int     @default(0)
  isRequired   Boolean @default(true)
  createdAt    DateTime @default(now())
  team         Team    @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([teamId, month, equipmentName])
  @@index([teamId, month])
  @@index([teamId, month, displayOrder])
  @@map("InspectionTemplates")
}

// 신규: 월별 점검 일정 마스터 (공장별 월별 점검 항목)
model InspectionScheduleTemplate {
  id            Int      @id @default(autoincrement())
  factoryId     Int      // 아산공장 or 화성공장
  month         Int      // 1-12
  equipmentName String   // "지게차 점검", "크레인 점검" 등
  displayOrder  Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  factory       Factory  @relation(fields: [factoryId], references: [id], onDelete: Cascade)

  @@unique([factoryId, month, equipmentName])
  @@index([factoryId, month])
  @@index([factoryId])
  @@map("InspectionScheduleTemplates")
}

// 신규: 월별 점검일 관리 (공장별 월별로 하나의 점검일)
model MonthlyInspectionDay {
  id            Int      @id @default(autoincrement())
  factoryId     Int
  month         Int      // 1-12
  inspectionDay Int      // 점검일 (1-31)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  factory       Factory  @relation(fields: [factoryId], references: [id], onDelete: Cascade)

  @@unique([factoryId, month])
  @@index([factoryId])
  @@index([factoryId, month])
  @@map("MonthlyInspectionDays")
}

// 안전점검 메인 (월별 점검 기록)
model SafetyInspection {
  id              String           @id @default(uuid())
  teamId          Int
  year            Int
  month           Int
  inspectionDate  DateTime         // 실제 점검 날짜 (매월 4일)
  isCompleted     Boolean          @default(false)
  completedAt     DateTime?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  team            Team             @relation(fields: [teamId], references: [id], onDelete: Cascade)
  inspectionItems InspectionItem[]

  @@unique([teamId, year, month])
  @@index([teamId])
  @@index([year, month])
  @@index([teamId, year, month])
  @@map("SafetyInspections")
}

// 안전점검 항목 (개별 기기 사진)
model InspectionItem {
  id                 String           @id @default(uuid())
  inspectionId       String
  equipmentName      String           // 기기명
  requiredPhotoCount Int              // 필요한 사진 개수 (해당 라인의 장비 개수)
  photos             Json             // JSON array of photo URLs
  remarks            String?          // 비고
  isCompleted        Boolean          @default(false) // 필요한 사진을 모두 업로드했는지
  uploadedAt         DateTime         @default(now())
  inspection         SafetyInspection @relation(fields: [inspectionId], references: [id], onDelete: Cascade)

  @@unique([inspectionId, equipmentName])
  @@index([inspectionId])
  @@map("InspectionItems")
}

// ========== 단순화된 이메일 시스템 ==========

// 간소화된 이메일 설정 (5가지 주요 이메일만 관리)
model SimpleEmailConfig {
  id            String   @id @default(uuid())
  emailType     String   @unique // "EXEC_SIGNATURE_REQUEST", "EXEC_SIGNATURE_COMPLETE", "TBM_REMINDER", "EDUCATION_REMINDER", "INSPECTION_REMINDER"
  subject       String   // 이메일 제목
  content       String   @db.Text // HTML 내용 (직접 수정 가능)
  enabled       Boolean  @default(true)

  // 발송 시점 설정
  sendTiming    String   // "IMMEDIATE", "AFTER_N_DAYS", "SCHEDULED_TIME", "MONTHLY_DAY"
  daysAfter     Int?     // N일 후 (sendTiming="AFTER_N_DAYS"일 때)
  scheduledTime String?  // 특정 시간 "HH:MM" (sendTiming="SCHEDULED_TIME"일 때)
  monthlyDay    Int?     // 월별 특정일 1-31 (sendTiming="MONTHLY_DAY"일 때)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([emailType])
  @@index([enabled])
  @@map("SimpleEmailConfigs")
}

// 이메일 발송 이력 (추적 및 통계)
model EmailLog {
  id             String   @id @default(uuid())
  emailType      String   // 이메일 타입
  recipientId    String   // 수신자 User ID
  recipientEmail String   // 수신자 이메일
  subject        String   // 발송된 이메일 제목
  sentAt         DateTime @default(now())
  status         String   @default("sent") // "sent", "failed", "bounced"
  errorMessage   String?  @db.Text

  @@index([emailType])
  @@index([recipientId])
  @@index([recipientEmail])
  @@index([sentAt])
  @@index([status])
  @@map("EmailLogs")
}

// ========== 공휴일 관리 ==========

// 공휴일 모델 (TBM 작성 필요 여부 판단에 사용)
model Holiday {
  id          Int      @id @default(autoincrement())
  date        DateTime @db.Date // 공휴일 날짜
  name        String   // 공휴일 이름 (예: 설날, 추석, 어린이날 등)
  isRecurring Boolean  @default(false) // 매년 반복 여부 (양력 기준)
  site        String?  // 사이트별 적용 (null이면 전체 적용)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([date, site])
  @@index([date])
  @@index([site])
  @@map("Holidays")
}

// ========== 세션 스토어 ==========

// Express 세션 저장 테이블 (connect-pg-simple)
model UserSession {
  sid    String   @id @db.VarChar
  sess   Json     @db.Json
  expire DateTime @db.Timestamp(6)

  @@index([expire], name: "IDX_session_expire")
  @@map("user_sessions")
}

// ========== 감사 로그 (Audit Log) ==========

// 모든 주요 작업의 추적 기록
model AuditLog {
  id         String   @id @default(cuid())
  action     String   // CREATE, UPDATE, DELETE, LOGIN, LOGOUT, APPROVE, REJECT, VIEW, EXPORT
  entityType String   // USER, TEAM, TBM_REPORT, INSPECTION, COURSE, APPROVAL, HOLIDAY, NOTICE
  entityId   String?  // 대상 엔티티 ID
  userId     String?  // 작업 수행 사용자 ID
  user       User?    @relation("AuditLogUser", fields: [userId], references: [id], onDelete: SetNull)

  oldValue   Json?    // 변경 전 값 (UPDATE, DELETE 시)
  newValue   Json?    // 변경 후 값 (CREATE, UPDATE 시)
  metadata   Json?    // 추가 메타데이터 (예: 필터 조건, 검색어 등)

  ipAddress  String?  // 클라이언트 IP
  userAgent  String?  // 브라우저/클라이언트 정보

  createdAt  DateTime @default(now())

  @@index([userId])
  @@index([entityType, entityId])
  @@index([action])
  @@index([createdAt])
  @@index([entityType, createdAt])
  @@map("AuditLogs")
}