generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                     String            @id @default(uuid())
  username               String            @unique
  name                   String?
  email                  String?           @unique
  password               String?
  role                   String            @default("WORKER")
  site                   String?
  teamId                 Int?
  createdAt              DateTime          @default(now())
  team                   Team?             @relation("TeamMembers", fields: [teamId], references: [id])
  ledTeams               Team[]            @relation("TeamLeader")
  approverTeams          Team[]            @relation("TeamApprover")      // 신규: 내가 결재자인 팀들
  notices                Notice[]
  createdApprovals       MonthlyApproval[] @relation("Approver")
  signatures             ReportSignature[]
  comments               Comment[]
  reportDetails          ReportDetail[]
  requestedApprovals     ApprovalRequest[] @relation("ApprovalRequester") // 신규: 내가 요청한 결재
  approvalsToApprove     ApprovalRequest[] @relation("ApprovalApprover")  // 신규: 내가 승인할 결재

  @@index([teamId])
  @@index([role])
  @@index([site])
  @@index([role, site])
}

model Notice {
  id             String       @id @default(uuid())
  title          String
  content        String
  authorId       String
  category       String       @default("GENERAL")
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  isActive       Boolean      @default(true)
  viewCount      Int          @default(0)
  imageUrl       String?
  attachmentUrl  String?
  attachmentName String?
  videoUrl       String?      // 신규: 동영상 URL (mp4 파일 또는 유튜브)
  videoType      String?      // 신규: 'file' | 'youtube'
  author         User         @relation(fields: [authorId], references: [id], onDelete: Cascade)
  comments       Comment[]
  attachments    Attachment[]

  @@index([authorId])
  @@index([createdAt])
  @@index([category])
  @@index([category, createdAt])
}

model Comment {
  id          String       @id @default(uuid())
  content     String
  imageUrl    String?
  authorId    String
  noticeId    String
  createdAt   DateTime     @default(now())
  author      User         @relation(fields: [authorId], references: [id], onDelete: Cascade)
  notice      Notice       @relation(fields: [noticeId], references: [id], onDelete: Cascade)
  attachments Attachment[]

  @@index([authorId])
  @@index([noticeId])
}

model Course {
  id              String           @id @default(uuid())
  title           String
  description     String
  type            String
  duration        Int
  videoUrl        String?
  videoType       String?          // 신규: 'youtube' | 'file' | 'audio'
  audioUrl        String?          // 신규: 음성 파일 URL
  documentUrl     String?
  color           String           @default("blue")
  icon            String
  isActive        Boolean          @default(true)
  assessments     Assessment[]
  certificates    Certificate[]
  userAssessments UserAssessment[]
  userProgress    UserProgress[]
  attachments     Attachment[]     // 여러 미디어 파일 지원
}

model UserProgress {
  id           String   @id @default(uuid())
  userId       String
  courseId     String
  progress     Int      @default(0)
  completed    Boolean  @default(false)
  currentStep  Int      @default(1)
  timeSpent    Int      @default(0)
  lastAccessed DateTime @default(now())
  course       Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([courseId])
}

model Assessment {
  id            String @id @default(uuid())
  courseId      String
  question      String
  options       String
  correctAnswer Int
  difficulty    String @default("medium")
  course        Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@index([courseId])
}

model UserAssessment {
  id             String   @id @default(uuid())
  userId         String
  courseId       String
  score          Int
  totalQuestions Int
  passed         Boolean
  attemptNumber  Int      @default(1)
  completedAt    DateTime @default(now())
  course         Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([courseId])
}

model Certificate {
  id             String   @id @default(uuid())
  userId         String
  courseId       String
  certificateUrl String
  issuedAt       DateTime @default(now())
  course         Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([courseId])
}

model Team {
  id                  Int                   @id @default(autoincrement())
  name                String
  site                String?
  leaderId            String?
  approverId          String?               // 신규: 월별보고서 결재자
  leader              User?                 @relation("TeamLeader", fields: [leaderId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  approver            User?                 @relation("TeamApprover", fields: [approverId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  members             User[]                @relation("TeamMembers")
  teamMembers         TeamMember[]          // 신규: User 계정 없는 팀원들
  checklistTemplates  ChecklistTemplate[]
  dailyReports        DailyReport[]
  monthlyApprovals    MonthlyApproval[]
  inspectionTemplates InspectionTemplate[]  // 신규: 안전점검 템플릿
  safetyInspections   SafetyInspection[]    // 신규: 안전점검 기록

  @@map("Teams")
}

// 신규 모델: 팀원 (User 계정 없이 팀장이 직접 관리)
model TeamMember {
  id               Int               @id @default(autoincrement())
  teamId           Int
  name             String            // 팀원 이름
  position         String?           // 직책
  isActive         Boolean           @default(true)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  team             Team              @relation(fields: [teamId], references: [id], onDelete: Cascade)
  reportSignatures ReportSignature[]
  absenceRecords   AbsenceRecord[]

  @@index([teamId])
  @@index([teamId, isActive])
  @@map("TeamMembers")
}

// 신규 모델: 부재 사유 기록
model AbsenceRecord {
  id          Int         @id @default(autoincrement())
  memberId    Int
  reportId    Int
  absenceType String      // '연차', '반차', '출장', '교육', '기타'
  reason      String?     // 기타 사유
  createdAt   DateTime    @default(now())
  member      TeamMember  @relation(fields: [memberId], references: [id], onDelete: Cascade)
  report      DailyReport @relation(fields: [reportId], references: [id], onDelete: Cascade)

  @@index([memberId])
  @@index([reportId])
  @@map("AbsenceRecords")
}

model ChecklistTemplate {
  id            Int            @id @default(autoincrement())
  name          String
  teamId        Int
  team          Team           @relation(fields: [teamId], references: [id], onDelete: Cascade)
  templateItems TemplateItem[]

  @@index([teamId])
  @@map("ChecklistTemplates")
}

model TemplateItem {
  id           Int               @id @default(autoincrement())
  templateId   Int
  category     String
  subCategory  String?
  description  String
  displayOrder Int               @default(0)
  template     ChecklistTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  reportDetails ReportDetail[]

  @@index([templateId])
  @@map("TemplateItems")
}

model DailyReport {
  id               Int               @id @default(autoincrement())
  teamId           Int
  reportDate       DateTime
  managerName      String?
  remarks          String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  site             String?
  team             Team              @relation(fields: [teamId], references: [id], onDelete: NoAction)
  reportDetails    ReportDetail[]
  reportSignatures ReportSignature[]
  absenceRecords   AbsenceRecord[]   // 신규: 부재 사유 기록

  @@index([teamId])
  @@index([reportDate])
  @@index([site])
  @@index([teamId, reportDate])
  @@index([site, reportDate])
  @@map("DailyReports")
}

model ReportDetail {
  id                Int           @id @default(autoincrement())
  reportId          Int
  itemId            Int
  checkState        String?
  authorId          String?
  actionDescription String?
  actionStatus      String?       @default("PENDING")
  item              TemplateItem  @relation(fields: [itemId], references: [id], onDelete: Cascade)
  report            DailyReport   @relation(fields: [reportId], references: [id], onDelete: Cascade)
  author            User?         @relation(fields: [authorId], references: [id])
  attachments       Attachment[]

  @@index([reportId])
  @@index([itemId])
  @@index([authorId])
  @@map("ReportDetails")
}

model ReportSignature {
  id             Int         @id @default(autoincrement())
  reportId       Int
  userId         String?     // User 계정이 있는 경우 (관리자용)
  memberId       Int?        // TeamMember (일반 팀원용) - userId와 memberId 중 하나만 사용
  signedAt       DateTime    @default(now())
  signatureImage String?
  report         DailyReport @relation(fields: [reportId], references: [id], onDelete: Cascade)
  user           User?       @relation(fields: [userId], references: [id], onDelete: Cascade)
  member         TeamMember? @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([reportId])
  @@index([userId])
  @@index([memberId])
  @@map("ReportSignatures")
}

model MonthlyApproval {
  id              String           @id @default(uuid())
  teamId          Int
  year            Int
  month           Int
  status          String           @default("DRAFT")
  pdfUrl          String?
  approverId      String?
  submittedAt     DateTime?
  approvedAt      DateTime?
  team            Team             @relation(fields: [teamId], references: [id])
  approver        User?            @relation("Approver", fields: [approverId], references: [id], onDelete: SetNull)
  approvalRequest ApprovalRequest? // 신규: 결재 요청

  @@unique([teamId, year, month])
  @@index([teamId])
  @@index([approverId])
}

// 신규 모델: 결재 요청 및 승인
model ApprovalRequest {
  id                 String          @id @default(uuid())
  reportId           String          @unique
  requesterId        String          // 요청자 (팀관리자)
  approverId         String          // 승인자 (임원)
  status             String          @default("PENDING") // PENDING, APPROVED, REJECTED
  requestedAt        DateTime        @default(now())
  approvedAt         DateTime?
  rejectionReason    String?         // 반려 사유
  executiveSignature String?         // 임원 서명 이미지 (base64)
  monthlyReport      MonthlyApproval @relation(fields: [reportId], references: [id], onDelete: Cascade)
  requester          User            @relation("ApprovalRequester", fields: [requesterId], references: [id])
  approver           User            @relation("ApprovalApprover", fields: [approverId], references: [id])

  @@index([requesterId])
  @@index([approverId])
  @@index([status])
  @@index([requestedAt])
  @@map("ApprovalRequests")
}

model Attachment {
  id             String        @id @default(uuid())
  url            String
  name           String
  type           String        @default("file") // 'image' | 'file' | 'video' | 'youtube' | 'audio'
  size           Int           @default(0)
  mimeType       String        @default("application/octet-stream")
  createdAt      DateTime      @default(now())
  noticeId       String?
  notice         Notice?       @relation(fields: [noticeId], references: [id], onDelete: Cascade)
  commentId      String?
  comment        Comment?      @relation(fields: [commentId], references: [id], onDelete: Cascade)
  reportDetailId Int?
  reportDetail   ReportDetail? @relation(fields: [reportDetailId], references: [id], onDelete: Cascade)
  courseId       String?
  course         Course?       @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@index([noticeId])
  @@index([commentId])
  @@index([reportDetailId])
  @@index([courseId])
}

// ========== 안전점검 시스템 ==========

// 안전점검 템플릿 (라인별 점검할 기기 목록)
model InspectionTemplate {
  id           Int     @id @default(autoincrement())
  teamId       Int
  equipmentName String  // 점검할 기기명 (예: 지게차, 크레인 등)
  displayOrder Int     @default(0)
  isRequired   Boolean @default(true)
  createdAt    DateTime @default(now())
  team         Team    @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@index([teamId])
  @@index([teamId, displayOrder])
  @@map("InspectionTemplates")
}

// 안전점검 메인 (월별 점검 기록)
model SafetyInspection {
  id              String           @id @default(uuid())
  teamId          Int
  year            Int
  month           Int
  inspectionDate  DateTime         // 실제 점검 날짜 (매월 4일)
  isCompleted     Boolean          @default(false)
  completedAt     DateTime?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  team            Team             @relation(fields: [teamId], references: [id], onDelete: Cascade)
  inspectionItems InspectionItem[]

  @@unique([teamId, year, month])
  @@index([teamId])
  @@index([year, month])
  @@index([teamId, year, month])
  @@map("SafetyInspections")
}

// 안전점검 항목 (개별 기기 사진)
model InspectionItem {
  id            String           @id @default(uuid())
  inspectionId  String
  equipmentName String           // 기기명
  photoUrl      String           // 사진 URL
  remarks       String?          // 비고
  uploadedAt    DateTime         @default(now())
  inspection    SafetyInspection @relation(fields: [inspectionId], references: [id], onDelete: Cascade)

  @@index([inspectionId])
  @@map("InspectionItems")
}

// ========== 이메일 템플릿 및 스케줄 시스템 ==========

// 이메일 템플릿
model EmailTemplate {
  id          String          @id @default(uuid())
  name        String          // 템플릿 이름
  type        String          // EDUCATION_REMINDER, TBM_REMINDER, SAFETY_INSPECTION_REMINDER, etc.
  subject     String          // 이메일 제목 (변수 포함 가능)
  htmlContent String          @db.Text // HTML 본문 (변수 포함 가능: {{variableName}})
  variables   String          @db.Text // JSON 배열: 사용 가능한 변수 목록
  description String?         // 템플릿 설명
  isActive    Boolean         @default(true)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  schedules   EmailSchedule[]
  conditions  EmailCondition[]

  @@index([type])
  @@index([isActive])
  @@map("EmailTemplates")
}

// 이메일 스케줄 (cron 기반 자동 발송)
model EmailSchedule {
  id           String        @id @default(uuid())
  name         String        // 스케줄 이름
  templateId   String        // 사용할 템플릿
  cronExpression String      // cron 표현식 (예: "0 7 * * *")
  description  String?       // 스케줄 설명
  isEnabled    Boolean       @default(true)
  lastRun      DateTime?     // 마지막 실행 시간
  nextRun      DateTime?     // 다음 실행 시간
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  template     EmailTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  sendLogs     EmailSendLog[]

  @@index([templateId])
  @@index([isEnabled])
  @@index([nextRun])
  @@map("EmailSchedules")
}

// 이메일 조건 정의 (상태 기반 자동 발송)
model EmailCondition {
  id              String   @id @default(uuid())
  name            String   // "TBM 3일 미작성 알림"
  conditionType   String   // "TBM_NOT_SUBMITTED_DAYS", "MONTHLY_REPORT_COMPLETED", etc.
  parameters      String   @db.Text // JSON: {"days": 3, "targetRole": "TEAM_LEADER"}
  templateId      String   // 어떤 이메일 템플릿을 사용할지
  recipientType   String   // "TEAM_LEADER", "EXECUTIVE", "SPECIFIC_USER", "AFFECTED_USER", "CUSTOM"
  recipientConfig String?  @db.Text // JSON: 커스텀 수신자 로직 (예: 특정 사용자 ID 목록)
  isEnabled       Boolean  @default(true)
  description     String?  @db.Text
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  template        EmailTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  sendLogs        EmailSendLog[]

  @@index([conditionType])
  @@index([isEnabled])
  @@index([templateId])
  @@map("EmailConditions")
}

// 이메일 발송 이력 (중복 발송 방지 및 추적)
model EmailSendLog {
  id             String   @id @default(uuid())
  conditionId    String?  // EmailCondition에서 발송된 경우
  scheduleId     String?  // EmailSchedule에서 발송된 경우
  templateType   String   // 템플릿 타입
  recipientId    String   // 수신자 User ID
  recipientEmail String   // 수신자 이메일
  sentAt         DateTime @default(now())
  status         String   @default("sent") // "sent", "failed", "bounced"
  errorMessage   String?  @db.Text
  condition      EmailCondition? @relation(fields: [conditionId], references: [id], onDelete: SetNull)
  schedule       EmailSchedule?  @relation(fields: [scheduleId], references: [id], onDelete: SetNull)

  @@index([conditionId])
  @@index([scheduleId])
  @@index([recipientId])
  @@index([recipientEmail])
  @@index([sentAt])
  @@index([status])
  @@map("EmailSendLogs")
}