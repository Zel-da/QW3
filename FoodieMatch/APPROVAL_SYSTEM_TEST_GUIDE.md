# 월별보고서 결재 시스템 테스트 가이드

## 📋 시스템 개요

월별보고서 결재 시스템은 다음과 같은 워크플로우로 동작합니다:

```
1. 팀 관리자가 결재자 설정 (팀 관리 페이지)
2. 팀 리더가 월별보고서 결재 요청 (월별보고서 페이지)
3. 결재자의 이메일로 결재 링크 발송
4. 결재자가 링크 클릭하여 ApprovalPage 접속
5. 결재자가 서명하고 승인/반려
6. 요청자에게 결과 이메일 발송
7. 월별보고서 페이지에 서명 표시
8. 팀 엑셀 다운로드 시 서명 포함
```

---

## ✅ 사전 준비

### 1. 이메일 서비스 설정 확인

`.env` 파일에 SMTP 설정이 올바른지 확인:

```bash
SMTP_HOST=192.168.1.100
SMTP_PORT=25
SMTP_FROM=safety@yourcompany.com
BASE_URL=http://192.68.10.249:5173
```

### 2. 스케줄러 활성화 (선택사항)

개발 환경에서 자동 알림을 테스트하려면 `.env`에 추가:

```bash
ENABLE_EMAIL_SCHEDULERS=true
```

### 3. 테스트 계정 준비

- **ADMIN 계정**: 팀 관리 권한
- **TEAM_LEADER 계정**: 결재 요청 권한
- **EXECUTIVE 계정** (또는 결재 권한이 있는 계정): 결재 승인 권한

---

## 🧪 테스트 시나리오

### 시나리오 1: 결재자 설정

1. **ADMIN 계정**으로 로그인
2. **팀 관리** 페이지로 이동
3. 특정 팀 선택
4. "월별보고서 결재자 설정" 드롭다운 클릭
5. 결재자 선택 (예: EXECUTIVE 계정)

**✅ 확인 사항:**
- 드롭다운이 정상적으로 열리는가?
- 사용자 목록이 표시되는가?
- 선택한 결재자가 저장되는가?

**❌ 문제 발생 시:**
- 서버 콘솔에서 에러 확인
- `TeamManagementPage.tsx:644-681` 코드 확인
- 사용자 목록 API `/api/users` 정상 응답 확인

---

### 시나리오 2: 결재 요청

1. **TEAM_LEADER 계정**으로 로그인
2. **월별보고서** 페이지로 이동
3. 연도/월 선택
4. 팀 선택
5. **"결재 요청"** 버튼 클릭

**✅ 확인 사항:**
- "결재 요청 완료" 토스트 메시지가 표시되는가?
- 서버 콘솔에 결재 요청 생성 로그가 표시되는가?
- 이메일이 결재자에게 발송되었는가?

**서버 로그 예시:**
```
[Monthly Approval] Creating approval request...
[Monthly Approval] Team ID: 3, Year: 2025, Month: 11
[Monthly Approval] Approver email: executive@company.com
[Approval] Approval request email sent to executive@company.com
```

**❌ 문제 발생 시:**
- 결재자가 설정되지 않았을 경우: "결재자가 설정되지 않았습니다" 메시지
- 이미 결재 요청이 존재하는 경우: "이미 결재 요청이 존재합니다" 메시지
- 서버 콘솔에서 에러 메시지 확인

---

### 시나리오 3: 이메일 확인

결재자의 이메일 계정으로 이동하여 확인:

**✅ 확인 사항:**
- 제목: `[결재요청] [팀명] 2025년 11월 TBM 보고서 결재`
- 본문에 요청자, 팀명, 보고 기간 정보가 올바른가?
- "결재하러 가기" 버튼이 있는가?
- 링크가 유효한가? (예: `http://192.68.10.249:5173/approval/123e4567-...`)

**❌ 이메일이 오지 않는 경우:**
1. SMTP 서버 연결 확인
2. 결재자의 이메일 주소가 올바른지 확인
3. 서버 콘솔에서 이메일 발송 로그 확인
4. 스팸 메일함 확인

---

### 시나리오 4: 결재 승인

1. 이메일에서 **"결재하러 가기"** 버튼 클릭
2. ApprovalPage로 이동
3. 결재 정보 확인:
   - 요청자 이름
   - 팀명
   - 보고 기간
4. **서명 캔버스**에 마우스/터치로 서명
5. **"결재 완료"** 버튼 클릭

**✅ 확인 사항:**
- ApprovalPage가 정상적으로 로드되는가?
- 서명 캔버스가 동작하는가?
- "결재가 완료되었습니다" 메시지가 표시되는가?
- 요청자에게 승인 완료 이메일이 발송되었는가?

**서버 로그 예시:**
```
[Approval] Approving request: 123e4567-...
[Approval] Approval notification email sent to teamleader@company.com
```

**❌ 문제 발생 시:**
- 401 Unauthorized: 로그인하지 않은 상태
- 403 Forbidden: 결재 권한이 없는 사용자
- 404 Not Found: 잘못된 결재 요청 ID
- 서명이 저장되지 않음: 서명 캔버스 데이터 확인

---

### 시나리오 5: 결재 반려 (선택사항)

ApprovalPage에서:

1. **"반려"** 버튼 클릭
2. 반려 사유 입력
3. 확인

**✅ 확인 사항:**
- 반려 사유 입력 다이얼로그가 표시되는가?
- 요청자에게 반려 알림 이메일이 발송되었는가?
- 반려 사유가 이메일에 포함되어 있는가?

---

### 시나리오 6: 서명 표시 확인

**TEAM_LEADER 계정**으로 로그인:

1. **월별보고서** 페이지로 이동
2. 결재 요청한 연도/월/팀 선택
3. **"관리감독자 결재 정보"** 카드 확인

**✅ 확인 사항:**
- 결재 상태가 "승인 완료"로 표시되는가?
- 결재자 이름이 표시되는가?
- 승인 일시가 표시되는가?
- 서명 이미지가 표시되는가?

**반려된 경우:**
- 결재 상태가 "반려됨"으로 표시되는가?
- 반려 사유가 표시되는가?

---

### 시나리오 7: 팀 엑셀 다운로드

월별보고서 페이지에서:

1. **"팀 엑셀"** 버튼 클릭
2. 다운로드된 엑셀 파일 열기
3. 첫 번째 시트 확인

**✅ 확인 사항:**
- "관리감독자" 영역(T3:Z4)에 결재자 이름과 날짜가 표시되는가?
- "승인/확인" 영역(AA3:AG4)에 서명 이미지가 삽입되어 있는가?
- 서명 이미지가 올바르게 표시되는가?

**❌ 문제 발생 시:**
- 서명이 없는 경우: 결재가 승인되지 않았거나 서명 데이터가 누락됨
- 이미지가 깨지는 경우: base64 인코딩 문제
- 서버 콘솔에서 엑셀 생성 로그 확인

---

## 🔄 자동 알림 테스트 (3일 대기 알림)

### 준비 단계

1. `.env`에 `ENABLE_EMAIL_SCHEDULERS=true` 추가
2. 서버 재시작
3. 서버 콘솔에서 스케줄러 시작 확인:

```
⏰ 조건부 이메일 체크 스케줄러 시작 (매 시간 정각)
```

### 테스트 방법

**실제 테스트 (3일 대기):**
1. 결재 요청 생성
2. 3일 동안 승인하지 않음
3. 3일 후 매 시간 정각에 자동 알림 확인

**빠른 테스트 (시간 단축):**

`server/scheduler.ts` 파일 수정 (임시):

```typescript
// 기존: 매 시간 정각
cron.schedule('0 * * * *', async () => {

// 변경: 5분마다 (테스트용)
cron.schedule('*/5 * * * *', async () => {
```

그리고 `server/emailConditions.ts`에서 조건 수정:

```typescript
// APPROVAL_PENDING_DAYS 조건에서 days 값을 3에서 0으로 변경 (임시)
```

**✅ 확인 사항:**
- 조건에 맞는 결재 요청이 존재하는가?
- 매 시간 정각(또는 5분마다)에 이메일이 발송되는가?
- 24시간 내 중복 발송이 방지되는가?

---

## 📊 전체 플로우 검증 체크리스트

- [ ] 팀 관리에서 결재자 설정 성공
- [ ] 월별보고서에서 결재 요청 성공
- [ ] 결재자에게 이메일 발송 확인
- [ ] 이메일 링크 클릭하여 ApprovalPage 접속
- [ ] 서명하고 결재 승인 성공
- [ ] 요청자에게 승인 완료 이메일 발송 확인
- [ ] 월별보고서 페이지에 서명 정보 표시 확인
- [ ] 팀 엑셀 다운로드에 서명 이미지 포함 확인
- [ ] (선택) 결재 반려 시나리오 확인
- [ ] (선택) 3일 대기 자동 알림 확인

---

## 🐛 트러블슈팅

### 문제 1: 결재 요청이 실패함

**에러**: "Failed to create approval request"

**해결 방법:**
1. 팀에 결재자가 설정되어 있는지 확인
2. 서버 콘솔에서 상세 에러 로그 확인
3. `POST /api/monthly-approvals/request` 엔드포인트 확인
4. 데이터베이스 연결 상태 확인

### 문제 2: 이메일이 발송되지 않음

**해결 방법:**
1. SMTP 설정 확인 (`.env` 파일)
2. 결재자의 이메일 주소가 올바른지 확인
3. 서버 콘솔에서 이메일 발송 로그 확인
4. SMTP 서버 연결 테스트:
   ```bash
   Test-NetConnection -ComputerName 192.168.1.100 -Port 25
   ```

### 문제 3: ApprovalPage 접속 시 에러

**401 Unauthorized:**
- 로그인하지 않은 상태 → 로그인 필요

**403 Forbidden:**
- 결재 권한이 없는 사용자 → 올바른 결재자 계정으로 접속

**404 Not Found:**
- 잘못된 결재 요청 ID → 이메일 링크 확인

### 문제 4: 서명이 저장되지 않음

**해결 방법:**
1. 서명 캔버스에 실제로 그렸는지 확인
2. 브라우저 콘솔에서 에러 확인
3. 서명 데이터가 base64로 변환되는지 확인
4. 서버 로그에서 `approverSignature` 필드 확인

### 문제 5: 엑셀에 서명 이미지가 없음

**해결 방법:**
1. 결재가 승인되었는지 확인 (status: 'APPROVED')
2. `approverSignature` 필드에 데이터가 있는지 확인
3. 서버 콘솔에서 엑셀 생성 로그 확인:
   ```
   [Excel] Failed to add signature image
   ```
4. base64 이미지 데이터가 유효한지 확인

---

## 📝 API 엔드포인트 참고

| 엔드포인트 | 메소드 | 용도 |
|-----------|--------|------|
| `/api/monthly-approvals/request` | POST | 월별보고서 결재 요청 생성 |
| `/api/approvals/pending` | GET | 대기 중인 결재 목록 조회 |
| `/api/approvals/:id` | GET | 특정 결재 요청 조회 |
| `/api/approvals/:id/approve` | POST | 결재 승인 |
| `/api/approvals/:id/reject` | POST | 결재 반려 |
| `/api/reports/monthly` | GET | 월별보고서 조회 (서명 포함) |
| `/api/reports/monthly-excel` | GET | 팀 엑셀 다운로드 (서명 포함) |

---

## ✅ 성공 기준

모든 테스트 시나리오가 통과하면 결재 시스템이 정상적으로 동작하는 것입니다:

1. ✅ 결재자 설정 가능
2. ✅ 결재 요청 생성 및 이메일 발송
3. ✅ 결재 승인/반려 기능 동작
4. ✅ 서명 이미지 저장 및 표시
5. ✅ 엑셀 다운로드에 서명 포함
6. ✅ 3일 대기 자동 알림 발송 (선택)

---

## 🎉 테스트 완료!

모든 테스트를 완료하셨다면, 결재 시스템이 정상적으로 작동하고 있는 것입니다.

추가 문의사항이 있으시면 서버 로그를 확인하거나 개발팀에 문의해주세요.
